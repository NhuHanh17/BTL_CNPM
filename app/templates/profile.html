{% extends 'layout/base.html' %}

{% block title %}
    <title>Profile</title>
{% endblock %} 

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

<div class="profile-section">
    <div class="container">
        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="card card-dark p-0 border-0 bg-transparent">
                    <div class="vip-card text-center pb-5">
                        <h5 class="text-uppercase fw-bold ls-2 mb-0">Member Card</h5>
                        <small class="opacity-75">Karaoke Star Club</small>
                    </div>
                    
                    <div class="card-body card-dark text-center mt-n4 pt-0">
                        <div class="avatar-container">
                            <img src="{{ current_user.avatar }}" alt="{{ current_user}}" class="avatar-img">
                        </div>
                        
                        <h4 class="fw-bold mt-2">{{ current_user.fullname }}</h4>
                        <p class="text-secondary mb-3">@{{ current_user.username }}</p>
                        

                        <hr class="border-secondary">
                        
                        <div class="row text-center">
                            <div class="col-6 border-end border-secondary">
                                <h5 class="mb-0 fw-bold">{{ count }}</h5>
                                <small class="text-secondary">Số booking</small>
                            </div>
                            <div class="col-6">
                                <h5 class="mb-0 fw-bold">0</h5>
                                <small class="text-secondary">Đã hát</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card card-dark h-100">
                    <div class="card-header border-bottom border-secondary bg-transparent pt-3 px-4">
                        <ul class="nav nav-tabs card-header-tabs" id="profileTab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info">Thông tin cá nhân</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history">Lịch sử đặt phòng</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#password">Đổi mật khẩu</button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body p-4">
                        <div class="tab-content" id="profileTabContent">
                            
                            <div class="tab-pane fade show active" id="info">
                                <form>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Họ và tên</label>
                                            <input type="text" class="form-control form-control-dark" value="{{ current_user.fullname }}" >
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Số điện thoại</label>
                                            <input type="text" class="form-control form-control-dark" value="{{ current_user.phone_number }}" readonly>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Avatar</label>
                                            <input type="file" class="form-control form-control-dark" >
                                        </div>
                                        <div class="col-12 mt-4 text-end">
                                            <button type="button" class="btn btn-outline-secondary me-2">Hủy</button>
                                            <button type="submit" class="btn btn-danger fw-bold px-4" style="background-color: #d63384; border:none;">Lưu thay đổi</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="tab-pane fade" id="history">
                                <div class="table-responsive">
                                    <table class="table table-dark table-hover align-middle">
                                        <thead>
                                            <tr class="text-secondary small text-uppercase">
                                                <th>Mã đơn</th>
                                                <th>Ngày hát</th>
                                                <th>Phòng</th>
                                                <th>Tổng tiền</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for history in histories %}
                                            <tr>
                                                <td>{{ history.id }}</td>
                                                <td>{{ history.start_datetime.strftime('%d/%m/%Y') }} <br><small class="text-secondary">{{ history.start_datetime.strftime('%H:%M') }}</small></td>
                                                <td>{{ history.room.name }}</td>
                                                <td class="text-warning fw-bold">{{ "{:,}".format(history.total_price) }}đ</td>
                                                <td>
                                                    {% if history.status == 'completed' %}
                                                    <span class="badge bg-success bg-opacity-25 text-success">Hoàn thành</span>
                                                    {% elif history.status == 'cancelled' %}
                                                    <span class="badge bg-danger bg-opacity-25 text-danger">Đã hủy</span>
                                                    {% else %}
                                                    <span class="badge bg-warning bg-opacity-25 text-warning">Đang chờ</span>
                                                    {% endif %}
                                                </td>
                                            </tr>   
                                            {% endfor %}            
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="password">
                                <form method="POST,GET" action="/change-password">
                                     {% if err_msg %}
                                        <div class="alert alert-danger">{{ err_msg }}</div>
                                    {% endif %}
                                    <div class="mb-3">
                                        <label class="form-label">Mật khẩu hiện tại</label>
                                        <input type="password" class="form-control form-control-dark" name="old_password" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Mật khẩu mới</label>
                                        <input type="password" class="form-control form-control-dark" name="new_password" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nhập lại mật khẩu mới</label>
                                        <input type="password" class="form-control form-control-dark" name="confirm_password">
                                    </div>
                                    <button class="btn btn-outline-light w-100 mt-2">Cập nhật mật khẩu</button>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}